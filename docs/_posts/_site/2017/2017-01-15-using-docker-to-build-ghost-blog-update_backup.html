<p>上一篇<a href="/using-docker-to-build-ghost-blog-install/">使用Docker构建Ghost博客(1/2)：安装</a>，我们通过Docker已经完成了Ghost博客系统的安装，本文将介绍如何对Ghost博客进行更新和备份。</p>

<h3 id="1备份ghost博客">1.备份Ghost博客</h3>
<h4 id="11-手动备份">1.1 手动备份</h4>
<p>部署Ghost的时候，很重要的一点是：将容器中Ghost的配置目录映射到本机目录。这样在更新Ghost镜像的时候，博客的数据和配置可以直接保留。
因此，我们只用备份当时映射的博客的配置目录即可。由于，我们使用的是SQLite数据库，数据库的备份十分简单，只用备份db文件即可。</p>

<ol>
  <li>停止容器。
<code class="highlighter-rouge">Docker stop my_ghost</code>，停止运行Ghost的Docker容器即可。（my_ghost是容器名）</li>
  <li>备份Ghost配置目录。
<code class="highlighter-rouge">tar -zcvf ghost_config.tar.gz ghost_config</code>，
将配置目录压缩打包到一个tar.gz文件里</li>
  <li>启动容器
<code class="highlighter-rouge">docker start my_ghost</code>，恢复博客访问
    <h4 id="12-自动备份">1.2 自动备份</h4>
    <p>当然，可以做成一个脚本，并部署到服务器的crontab里定期自动执行</p>
  </li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 容器名称（修改为自己的容器名称）</span>
<span class="nv">dockerName</span><span class="o">=</span>ghost_0.11.4
<span class="c"># 备份的配置文件目录</span>
<span class="nv">ghostConfigPath</span><span class="o">=</span>/root/ghost/ghost_config
<span class="c"># 备份文件.tar.gz的存储路径</span>
<span class="nv">backupPath</span><span class="o">=</span>/root/ghost/backup
<span class="c"># 备份文件时间戳后缀</span>
<span class="nv">timeStamp</span><span class="o">=</span><span class="sb">`</span>date +%Y%m%d%H%M%S<span class="sb">`</span>
docker stop <span class="nv">$dockerName</span>
<span class="nb">cd</span> <span class="nv">$backupPath</span>
<span class="nb">tar</span> <span class="nt">-zcvf</span> ghost_backup_<span class="k">${</span><span class="nv">timeStamp</span><span class="k">}</span>.tar.gz <span class="nv">$ghostConfigPath</span>
docker start <span class="nv">$dockerName</span>
</code></pre></div></div>
<p>然后将这个脚本部署在服务器上，通过如下crontab命令做到每日凌晨3:00备份</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0 3 * * * /root/ghost/backup/backup_ghost.sh 以后若要备份的时候，直接执行这个脚本即可。
</code></pre></div></div>

<h3 id="2-更新ghost博客">2. 更新Ghost博客</h3>
<p>Ghost博客程序更新版本后，也会同时发布新版本Ghost的Docker镜像。因此，==Ghost博客的更新问题，就完全变成了更新Docker镜像的问题。==</p>

<ol>
  <li>先做备份
未避免任何意外，建议先做备份。</li>
  <li>拉取最新的镜像
使用<code class="highlighter-rouge">docker pull ghost</code>，拉取最新的镜像。</li>
  <li>停止当前容器
<code class="highlighter-rouge">docker stop my_ghost</code></li>
  <li>删除当前容器
<code class="highlighter-rouge">docker rm my_ghost</code></li>
  <li>使用最新镜像，启动一个新的容器
<code class="highlighter-rouge">docker run --name my_ghost -d -p my_ghost 80:2368 -v /root/ghost/ghost_config:/var/lib/ghost ghost</code></li>
</ol>

<h3 id="3-总结">3. 总结</h3>
<ol>
  <li>使用Docker，屏蔽了对特定程序的<strong>管理差异性</strong>。转化为一致的Docker镜像的安装和升级操作。比如Ghost内部的安装和升级方法，几乎变成透明的。</li>
  <li>将状态数据保存到容器之外，做到容器本身无状态，方便容器升级。</li>
</ol>
