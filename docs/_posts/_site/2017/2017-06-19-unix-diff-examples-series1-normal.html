<p>在使用git的过程中，难免会用到git diff命令，用于比较文件差异。但初学者对这个命令的输出格式几乎都是一脸懵逼，需仔细研究一番。</p>

<p>我读过阮一峰的<a href="http://www.ruanyifeng.com/blog/2012/08/how_to_read_diff.html">《读懂diff》</a>，收获颇大，但还是写了本文。一来，阮一峰文章中的举例过于简单和特殊，有些问题没有解释清楚；二来，也是自己的一份总结。</p>

<h2 id="背景">背景</h2>

<p>git的diff，源于Unix的diff命；因此，追本溯源我们要从Unix的diff命令说起。</p>

<p>Unix的diff命令由于历史原因，又分为三种输出格式：</p>

<ul>
  <li>常规格式（normal diff）</li>
  <li>上下文格式（context diff）</li>
  <li>合并格式（unified diff）</li>
</ul>

<p>本文是系列的第一篇，介绍diff<strong>常规输出格式</strong>。</p>

<h2 id="diff命令的格式">diff命令的格式</h2>

<p>diff用于比较两个文件的差异，如果<strong>f1文件看做原文件，f2文件看做改动后的文件</strong>，那么直接执行<code class="highlighter-rouge"><span class="gh">diff f1 f2</span></code>，就完成了<strong>常规模式</strong>下对f1和f2的比较。</p>

<p>在开始之前，我们先要意识到：diff对文本，==是按行进行比较==的工具，所以你看到的输出，永远是针对行的描述。</p>

<h2 id="准备初始文件f0">准备初始文件f0</h2>
<p>为了研究diff命令的使用方法，我们准备了丰富的案例讲解。每个案例对应与一个改动文件，都与原始文件f0进行diff，便于大家学习。</p>

<p>首先，我们的初始文件f0的内容如下，一共14行：</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>11
22
33
44
55
66
77
88
99
00
aa
bb
cc
dd
</code></pre></div></div>
<p>为了便于识别，<strong>初始文件每行统一为2个字符；同时，任何改动的行，都会超过两个字符</strong>；因此，肉眼会很容易的辨别出改动点。</p>

<p>下面，就开始我们的案例之旅吧！</p>

<h3 id="案例0文件相同">案例0：文件相同</h3>
<p>我们让f0和f0自己比较，显然不会有任何差异行。</p>

<ul>
  <li>命令：<code class="highlighter-rouge"><span class="gh">diff f0 f0</span></code></li>
  <li>结果：不出所料，diff秉承了Unix的设计哲学：没消息就是好消息。因此没有给出任何输出。</li>
</ul>

<h3 id="案例c1修改一行内容">案例c1：修改一行内容</h3>
<p>将第5行修改为hello，形成文件c1：</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>11
22
33
44
hello
66
77
88
99
00
aa
bb
cc
dd
</code></pre></div></div>

<p>执行命令：<code class="highlighter-rouge"><span class="gh">diff f0 c1</span></code>，输出如下：</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>5c5
&lt; 55
---
&gt; hello
</code></pre></div></div>
<p>上述输出内容分内4行：</p>

<ol>
  <li>第1行是一个==变动提示==，<code class="highlighter-rouge">5c5</code>共3个字符，第一个5表示变动的行号；第二个c表示变动方式是修改(change)，其他的变动方式还有增加a（add）、删除d（delete）；第三个5表示变动后在新文件的行号，由于是修改因此，修改前后行号一样。</li>
  <li>第2行代表“删除操作”，<code class="highlighter-rouge">&lt;</code>代表删除，后面紧跟着删除的内容55；也就是说删除了55。</li>
  <li>第3行是三个横线，用于分隔删除和增加的内容。</li>
  <li>第4行是增加的内容，用<code class="highlighter-rouge">&gt;</code>表示，<code class="highlighter-rouge">&gt;</code>后就是具体增加的内容。</li>
</ol>

<p><strong>初步总结一下diff输出：</strong></p>

<blockquote>
  <ol>
    <li>diff先用一个字符串表示==变动提示==，包含：操作的行在旧文件的行号，操作的方式，以新文件的行号。</li>
    <li>操作被分解为“删除”和“新增”两步，分别用<code class="highlighter-rouge">&lt;</code>和<code class="highlighter-rouge">&gt;</code>表示，其后跟上的是具体内容。</li>
    <li>删除和新增两步之间，用<code class="highlighter-rouge">---</code>分隔。</li>
  </ol>
</blockquote>

<h3 id="案例c2修改两行内容相邻">案例c2：修改两行内容（相邻）</h3>
<p>案例c1只修改了一行，如果我们再多修改一行，会怎样？我们继续把第6行修改为world，形成文件c2：</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>11
22
33
44
hello
world
77
88
99
00
aa
bb
cc
dd
</code></pre></div></div>

<p>执行<code class="highlighter-rouge"><span class="gh">diff f0 c2</span></code>：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>5,6c5,6
&lt; 55
&lt; 66
---
&gt; hello
&gt; world
</code></pre></div></div>
<p>相比案例c1的输出，稍显复杂了：</p>

<ol>
  <li>变动提示里，c的两边的行号变成了5,6，代表是5到6行。</li>
  <li><code class="highlighter-rouge">---</code>的上下两部分也变成了两行内容。这容易理解，因为删除了两行内容，并新增了两行内容。</li>
</ol>

<p><strong>总结一下，在连续行修改的情况下：</strong></p>
<blockquote>
  <ol>
    <li>第一行操作提示，使用起始行号进行表示范围。</li>
    <li><code class="highlighter-rouge">---</code>上下，用多个<code class="highlighter-rouge">&lt;</code>和<code class="highlighter-rouge">&gt;</code>，标记连续删除和新增的内容。</li>
  </ol>
</blockquote>

<h3 id="案例c3修改两行内容不相邻">案例c3：修改两行内容（不相邻）</h3>
<p>若干修改的行不相邻，diff会怎么表示？我们把f0的第5行改为hello，第10行为world，修改后形成文件c3：</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>11
22
33
44
hello
66
77
88
99
world
aa
bb
cc
dd
</code></pre></div></div>

<p>执行<code class="highlighter-rouge"><span class="gh">diff f0 c3</span></code>：</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>5c5
&lt; 55
---
&gt; hello
10c10
&lt; 00
---
&gt; world
</code></pre></div></div>

<p>结果好像更复杂了，但在案例c1和案例c2的基础，仔细看：拆分看来，其实就是两个案例c1的操作而已，分别以<code class="highlighter-rouge">5c5</code>和<code class="highlighter-rouge">10c10</code>开头。</p>

<p><strong>总结：</strong></p>

<blockquote>
  <ol>
    <li>当修改内容不连续的时候，diff将修改==拆分为多个片段表示==，每个片段都是一个==完整的连续修改片段==。</li>
    <li>片段的开始符号是“修改提示”，即“原文件行号（或范围）” + 变动方式 + “新文件行号（或范围）”</li>
  </ol>
</blockquote>

<h3 id="案例c4综合情况">案例c4：综合情况</h3>

<p>将案例c1-c3的情况综合考虑，形成如下的文件c4：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>11
22
33
hello
world
!!!!
77
88
99
00
how are you
bb
cc
fine
</code></pre></div></div>
<p>文件修改了3处（连续的算作一处）：4-6行被修改了；11行变成了how are you；14行变成了fine；初步预测一下，<strong>diff应该会给出3个修改片段</strong>，其中第1个片段是一个连续的范围。</p>

<p>执行命令<code class="highlighter-rouge"><span class="gh">diff f0 c4</span></code>，结果不出所料：</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>4,6c4,6
&lt; 44
&lt; 55
&lt; 66
---
&gt; hello
&gt; world
&gt; !!!!
11c11
&lt; aa
---
&gt; how are you
14c14
&lt; dd
---
&gt; fine
</code></pre></div></div>

<p>以上都是原行修改的案例，下面我们看一下增加行的案例。</p>

<h3 id="案例a1增加一行内容">案例a1：增加一行内容</h3>

<p>与修改同理，我们从增加一行开始（在第5行下增加一行hello，变成了新文件的第6行），形成文件a1：</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>11
22
33
44
55
hello
66
77
88
99
00
aa
bb
cc
dd
</code></pre></div></div>
<p>执行<code class="highlighter-rouge"><span class="gh">diff f0 a1</span></code>：</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>5a6
&gt; hello
</code></pre></div></div>

<p>嚯，内容要比修改的情况简洁多了，但注意两点：</p>

<ol>
  <li>“变动提示”里，除操作方式用a表示增加（add）外；特别注意第3个6表示新文件的行号。由于是新增行，那么在新行自然是偏移到第6行了</li>
  <li>原来出现的<code class="highlighter-rouge">&lt;</code>和<code class="highlighter-rouge">---</code>都不见了，只剩下表示新增内容的<code class="highlighter-rouge">&gt;</code>。由于只存在增加内容，无需分隔，<code class="highlighter-rouge">---</code>被去除了，可以理解。</li>
</ol>

<p><strong>总结：</strong></p>

<blockquote>
  <ol>
    <li>变动提示<code class="highlighter-rouge">5a6</code>，表示在第5行后面新增，并形成新文件的第6行。</li>
    <li>新增操作不用分解，只保留了<code class="highlighter-rouge">&gt;</code>行的内容</li>
  </ol>
</blockquote>

<h3 id="案例a2增加两行内容连续">案例a2：增加两行内容（连续）：</h3>
<p>文件在第5行后，增加了两行内容，如下：</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>11
22
33
44
55
hello
world
66
77
88
99
00
aa
bb
cc
dd
</code></pre></div></div>

<p>执行<code class="highlighter-rouge"><span class="gh">diff f0 a2</span></code>，参考案例c2的经验，不出所料，结果如下，就不多解释了：</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>5a6,7
&gt; hello
&gt; world
</code></pre></div></div>

<h3 id="案例a3增加两行内容不相邻">案例a3：增加两行内容（不相邻）</h3>

<p>新增后的文件a3如下：</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>11
22
33
44
55
hello
66
77
88
99
00
world
aa
bb
cc
dd
</code></pre></div></div>
<p>执行<code class="highlighter-rouge"><span class="gh">diff f0 a3</span></code>，结果如下：</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>5a6
&gt; hello
10a12
&gt; world
</code></pre></div></div>

<p>不连续的时候，diff给出了两个新增片段，符合预期。</p>

<p>但注意第二个片段a后是12，而不是11，因为第一个新增也影响了新文件，所以到第二个新增操作的时候，<strong>其实已经偏移了2行</strong>。也就是说，变动提示中，新文件的行号受前面所有修改的影响的。</p>

<h3 id="案例a4综合情况">案例a4：综合情况</h3>
<p>多修改几处，形成a4：</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nihao
11
22
33
44
55
hello
world
66
77
88
99
00
how are you
aa
i am fine
bb
cc
dd
</code></pre></div></div>
<p>可以看出，首先在开头插入一行nihao，然后再55后连续增加了两行，接着分别不连续的新增了1行，执行<code class="highlighter-rouge"><span class="gh">diff f0 a4</span></code>，分为4个片段，结果如下：</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0a1
&gt; nihao
5a7,8
&gt; hello
&gt; world
10a14
&gt; how are you
11a16
&gt; i am fine
</code></pre></div></div>
<p>值得关注的是，在文件头增加的时候，操作提示中用0表示原文件的位置。</p>

<h3 id="案例d1删除一行">案例d1：删除一行</h3>
<p>我们把f0文件的第5行删除，形成文件d1：</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>11
22
33
44
66
77
88
99
00
aa
bb
cc
dd
</code></pre></div></div>

<p>执行<code class="highlighter-rouge"><span class="gh">diff f0 d1</span></code>，结果如下：</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>5d4
&lt; 55
</code></pre></div></div>
<ol>
  <li>和新增类似，这里只有<code class="highlighter-rouge">&lt;</code>行，没有<code class="highlighter-rouge">---</code>和<code class="highlighter-rouge">&gt;</code>行。</li>
  <li>变动提示中，==新文件的4表示删除内容近邻的上一行在新文件的位置==。</li>
</ol>

<h3 id="案例d2删除两行连续">案例d2：删除两行（连续）</h3>
<p>f0删除5,6两行后，形成文件d2：</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>11
22
33
44
77
88
99
00
aa
bb
cc
dd
</code></pre></div></div>

<p>执行<code class="highlighter-rouge"><span class="gh">diff f0 d2</span></code>，结果如下：</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>5,6d4
&lt; 55
&lt; 66
</code></pre></div></div>
<p>同理，不难理解。</p>

<h3 id="案例d3删除两行不连续">案例d3：删除两行（不连续）</h3>
<p>f0删除5和10两行后，形成d3：</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>11
22
33
44
66
77
88
99
aa
bb
cc
dd
</code></pre></div></div>

<p>执行<code class="highlighter-rouge"><span class="gh">diff f0 d2</span></code>，结果如下：</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>5d4
&lt; 55
10d8
&lt; 00
</code></pre></div></div>

<p>形成了两个删除片段。</p>

<h3 id="案例d4综合">案例d4：综合</h3>
<p>删除第1行，删除第5,6行，删除第12行，形成文件d4：</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>22
33
44
77
88
99
00
aa
cc
dd
</code></pre></div></div>
<p>执行<code class="highlighter-rouge"><span class="gh">diff f0 d4</span></code>：</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1d0
&lt; 11
5,6d3
&lt; 55
&lt; 66
12d8
&lt; bb
</code></pre></div></div>
<p>有三个删除片段，结合前边的例子，不难理解。</p>

<h3 id="综合案例acd增删改">综合案例acd：增删改</h3>
<p>有了上面的基础，我们模拟一下复杂的情况，包含了增删改的混合。与之前不同，我先给出diff的操作结果，看看你能不能反向推测出修改后的文件acd呢？</p>

<p>执行<code class="highlighter-rouge"><span class="gh">diff f0 acd</span></code>结果如下：</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0a1,2
&gt; today is sunday
&gt; i went to china
2d3
&lt; 22
3a5
&gt; yes it is
6,8c8
&lt; 66
&lt; 77
&lt; 88
---
&gt; hello
11c11,13
&lt; aa
---
&gt; first
&gt; secend
&gt; third
</code></pre></div></div>

<p>看起来是有点晕，最好准备一个编辑器，自己模拟一下。先将f0的内容拷贝到编辑器内，跟着操作：</p>

<ul>
  <li><code class="highlighter-rouge">0a1,2</code>，说明在文件头增加两行，修改后如下（==为了方便，我在每行前显示了行号==）：
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 today is sunday
2 i went to china
3 11
4 22
5 33
6 44
7 55
8 66
9 77
 10 88
 11 99
 12 00
 13 aa
 14 bb
 15 cc
 16 dd
</code></pre></div>    </div>
  </li>
  <li><code class="highlighter-rouge">2d3</code>，即将第2行删掉，注意是<strong>原文件</strong>的第2行（根据<code class="highlighter-rouge">&lt;</code>后看，也可以确认就是内容22的行）：
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 today is sunday
2 i went to china
3 11
4 33
5 44
6 55
7 66
8 77
9 88
 10 99
 11 00
 12 aa
 13 bb
 14 cc
 15 dd
</code></pre></div>    </div>
  </li>
  <li><code class="highlighter-rouge">3a5</code>，第3行增加一行，形成新文件的第5行，内容是yes it is：
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  1 today is sunday
  2 i went to china
  3 11
  4 33
  5 yes it is
  6 44
  7 55
  8 66
  9 77
 10 88
 11 99
 12 00
 13 aa
 14 bb
 15 cc
 16 dd
</code></pre></div>    </div>
  </li>
  <li><code class="highlighter-rouge">6,8c8</code>，这个和之前的有些区别，修改操作，但修改了原文件三行，新文件只有一行。不过只要理解修改就是删除+新增，变不难了。其实，就是将原文件的第6-8行删除，在替换为hello即可，于是形成：
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 today is sunday
2 i went to china
3 11
4 33
5 yes it is
6 44
7 55
8 hello
9 99
 10 00
 11 aa
 12 bb
 13 cc
 14 dd
</code></pre></div>    </div>
  </li>
  <li>最后一个操作：<code class="highlighter-rouge">11c11,13</code>，和上一个操作类似，修改后的行比修改前多。分析一下不过是删除了原文件11行，并在原位置插入了3行内容。最终修改成的文件就是：
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 today is sunday
2 i went to china
3 11
4 33
5 yes it is
6 44
7 55
8 hello
9 99
 10 00
 11 first
 12 secend
 13 third
 14 bb
 15 cc
 16 dd
</code></pre></div>    </div>
    <p>到此，diff的常规模式（normal）的输出情况，通过几个栗子几乎覆盖了。尤其是最后一个例子，反推回去如果能搞懂，就没什么问题了。</p>
  </li>
</ul>

<h2 id="总结">总结</h2>
<p>最后，对diff命令的常规模式总结如下：</p>

<blockquote>
  <ol>
    <li>diff可分辨变动的粒度是==一行==。</li>
    <li>任何变动，在diff看来，都可以分解为删除行和增加行。</li>
    <li>对与连续的变动，diff会用一个==变动片段==表示。其中变动片段分为4个部分：
a. 第一部分，即第一行，是==变动提示==，用“原文件行号（或范围）” + 变动模式 + “新文件行号（或范围）”表示，比如3c3。其中变动模式，分为a（增加）、c（修改）和d（删除）。
b. 第二部分和第四部分用<code class="highlighter-rouge">---</code>（即第三部分）分隔。
c. 第二部分表示删除的内容，每一行用<code class="highlighter-rouge">&lt;</code>开头，紧随的是具体删除的内容。
d. 第四部分表示增加的内容，每一行用<code class="highlighter-rouge">&gt;</code>开头，紧随的是具体增加的内容。
e. 当变动模式是a和d的时候，第二和第部分，只存在一个，同时<code class="highlighter-rouge">---</code>也会被省略。</li>
    <li>如果一个变动不连续，则会被拆解为多个变动片段表示。每个片段，都遵循第3条同样的规则。</li>
  </ol>
</blockquote>
